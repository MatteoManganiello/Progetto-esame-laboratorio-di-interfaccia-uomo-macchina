@using System.Globalization
@using Template.Web.Features.SuperAdmin
@model SuperAdminStatsViewModel

@{
    ViewData["Title"] = "Dashboard SuperAdmin";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <!-- KPI Cards -->
    <div class="row mb-4">
        <!-- Totale Utenti -->
        <div class="col-md-3 mb-3">
            <div class="card border-primary h-100 bg-primary bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Utenti Registrati</h6>
                            <h2 id="totalUtenti" class="mb-0">@Model.TotalUtenti</h2>
                        </div>
                        <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prenotazioni Attive -->
        <div class="col-md-3 mb-3">
            <div class="card border-success h-100 bg-success bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Prenotazioni Settimanali</h6>
                            <h2 id="prenotazioniSettimanali" class="mb-0">@Model.PrenotazioniSettimanali</h2>
                        </div>
                        <i class="fas fa-calendar-check fa-2x text-success opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spesa Totale -->
        <div class="col-md-3 mb-3">
            <div class="card border-warning h-100 bg-warning bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Spesa Totale</h6>
                            <h2 id="spesaTotale" class="mb-0">€@Model.SpesaTotale.ToString("N2")</h2>
                        </div>
                        <i class="fas fa-euro-sign fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spesa Media -->
        <div class="col-md-3 mb-3">
            <div class="card border-info h-100 bg-info bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Spesa Media</h6>
                            <h2 id="spesaMedia" class="mb-0">€@Model.SpesaMedia.ToString("N2")</h2>
                        </div>
                        <i class="fas fa-chart-bar fa-2x text-info opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessageSuperAdmin"] != null)
    {
        <div class="alert alert-success border-0">
            <i class="fa-solid fa-circle-check me-2"></i>@TempData["SuccessMessageSuperAdmin"]
        </div>
    }

    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white d-flex align-items-center">
                    <i class="fa-solid fa-shield-halved me-2"></i>
                    <h5 class="mb-0">Notifiche per Admin</h5>
                </div>
                <div class="card-body">
                    <form asp-controller="SuperAdmin" asp-action="NotificheAdmin" method="post">
                        @Html.AntiForgeryToken()
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Data</label>
                                <input class="form-control" type="date" name="Data" />
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Titolo</label>
                                <input class="form-control" name="Titolo" placeholder="Es. Aggiornamento policy" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Messaggio</label>
                                <textarea class="form-control" name="Contenuto" rows="3" placeholder="Scrivi la notifica per gli admin..."></textarea>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-dark">
                                <i class="fa-solid fa-paper-plane me-2"></i>Invia notifica
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="fa-solid fa-chart-pie me-2"></i>
                    <h5 class="mb-0">Spesa per sezione</h5>
                </div>
                <div class="card-body">
                    @if (Model.SpesaPerSezione == null || !Model.SpesaPerSezione.Any())
                    {
                        <p class="text-muted mb-0">Nessun dato disponibile.</p>
                    }
                    else
                    {
                        <div id="spesaSezioniBody" class="list-group list-group-flush">
                            @foreach (var s in Model.SpesaPerSezione)
                            {
                                <div class="list-group-item bg-transparent px-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">@s.Sezione</div>
                                        <small class="text-muted">@s.NumPrenotazioni prenotazioni</small>
                                    </div>
                                    <strong>€@s.SpesaTotale.ToString("N2")</strong>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>


    <!-- Tables Row -->
    <div class="row">
        <!-- Postazioni Più Prenotate -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building"></i> Postazioni Più Prenotate
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Postazione</th>
                                <th class="text-center">Prenotazioni</th>
                                <th class="text-end">Ricavo</th>
                            </tr>
                        </thead>
                        <tbody id="postazioniTableBody">
                            @foreach (var p in Model.PostazioniPiuPrenotate)
                            {
                                <tr>
                                    <td><strong>@p.Nome</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">@p.NumPrenotazioni</span>
                                    </td>
                                    <td class="text-end">€@p.SpesaTotale.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Utenti con Maggior Spesa -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star"></i> Top Utenti per Spesa
                    </h5>
                    <a href="@Url.Action("UtentiDettagli", "SuperAdmin")" class="btn btn-sm btn-outline-light">
                        Vedi Tutti
                    </a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Email</th>
                                <th class="text-center">Prenotazioni</th>
                                <th class="text-end">Spesa Totale</th>
                            </tr>
                        </thead>
                        <tbody id="utentiTableBody">
                            @foreach (var u in Model.UtentiMaggiorSpesa)
                            {
                                <tr>
                                    <td>
                                        <small>@u.Email</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@u.NumPrenotazioni</span>
                                    </td>
                                    <td class="text-end"><strong>€@u.SpesaTotale.ToString("N2")</strong></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    // Weekly Chart (Line)

    // Utility per formattazione Euro
    const fmtEuro = (v) => '€' + new Intl.NumberFormat('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);

    const sezioneColors = {
        'Sala eventi': 'bg-danger-subtle text-danger',
        'Sala meeting': 'bg-warning-subtle text-warning',
        'Dev team': 'bg-info-subtle text-info',
        'Desk room': 'bg-primary-subtle text-primary',
        'Ristorante': 'bg-success-subtle text-success'
    };

    function updateDashboard(stats) {
        // Alcuni serializer possono usare camelCase o PascalCase
        const s = stats;
        const get = (o, k) => o[k] ?? o[k.charAt(0).toUpperCase() + k.slice(1)];

        document.getElementById('totalUtenti').textContent = get(s, 'totalUtenti');
        document.getElementById('prenotazioniSettimanali').textContent = get(s, 'prenotazioniSettimanali');
        document.getElementById('spesaTotale').textContent = fmtEuro(get(s, 'spesaTotale'));
        document.getElementById('spesaMedia').textContent = fmtEuro(get(s, 'spesaMedia'));

        // Tabelle
        const postBody = document.getElementById('postazioniTableBody');
        const postazioni = get(s, 'postazioniPiuPrenotate') || [];
        postBody.innerHTML = postazioni.map(p => `
            <tr>
                <td><strong>${p.nome ?? p.Nome}</strong></td>
                <td class="text-center"><span class="badge bg-primary">${p.numPrenotazioni ?? p.NumPrenotazioni}</span></td>
                <td class="text-end">${fmtEuro(p.spesaTotale ?? p.SpesaTotale)}</td>
            </tr>
        `).join('');

        const sezioniBody = document.getElementById('spesaSezioniBody');
        const sezioni = get(s, 'spesaPerSezione') || [];
        if (sezioniBody) {
            sezioniBody.innerHTML = sezioni.map(x => `
                <div class="list-group-item bg-transparent px-0 d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">${x.sezione ?? x.Sezione}</div>
                        <small class="text-muted">${x.numPrenotazioni ?? x.NumPrenotazioni} prenotazioni</small>
                    </div>
                    <span class="badge ${sezioneColors[x.sezione ?? x.Sezione] ?? 'bg-secondary-subtle text-secondary'}">${fmtEuro(x.spesaTotale ?? x.SpesaTotale)}</span>
                </div>
            `).join('');
        }

        const utentiBody = document.getElementById('utentiTableBody');
        const utenti = get(s, 'utentiMaggiorSpesa') || [];
        utentiBody.innerHTML = utenti.map(u => `
            <tr>
                <td><small>${u.email ?? u.Email}</small></td>
                <td class="text-center"><span class="badge bg-info">${u.numPrenotazioni ?? u.NumPrenotazioni}</span></td>
                <td class="text-end"><strong>${fmtEuro(u.spesaTotale ?? u.SpesaTotale)}</strong></td>
            </tr>
        `).join('');
    }

    async function fetchStats() {
        try {
            const res = await fetch('/SuperAdmin/StatsJson', { cache: 'no-store' });
            if (!res.ok) return;
            const stats = await res.json();
            updateDashboard(stats);
        } catch (e) {
            console.warn('StatsJson fetch failed', e);
        }
    }

    // Polling ogni 7 secondi
    setInterval(fetchStats, 7000);
    // Primo aggiornamento dopo il render iniziale
    window.addEventListener('DOMContentLoaded', fetchStats);

</script>

<style>
    .card {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .card-header {
        border-bottom: 2px solid rgba(255,255,255,0.1);
    }
</style>
