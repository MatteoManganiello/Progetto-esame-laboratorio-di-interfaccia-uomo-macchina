@model Template.Web.Features.AreaRiservata.AreaRiservataViewModel
@{
    ViewData["Title"] = "Area Riservata";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-5">
    
@if (TempData["OrdineCancellato"] != null)
{
    var ordineCancellatoMessage = TempData["OrdineCancellato"]?.ToString() ?? string.Empty;
    var ordineCancellatoClass = ordineCancellatoMessage == "Ordine cancellato con successo."
        ? "alert-success"
        : "alert-warning";
    <div class="alert @ordineCancellatoClass alert-dismissible fade show shadow-sm border-0" role="alert">
        <i class="fas fa-check-circle me-2"></i>@ordineCancellatoMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container">
    <div class="row g-4">

        <div class="col-lg-4">
            <div class="card border border-dark border-opacity-10 shadow-sm h-100 overflow-hidden card-hover-effect">
                <div class="card-header bg-gradient-profile text-white py-4 text-center border-0">
                    <div class="mb-3">
                        <div class="avatar-placeholder mx-auto shadow-sm">
                            <span class="fs-1 fw-bold text-primary">@Model.Nome.Substring(0, 1).ToUpper()</span>
                        </div>
                    </div>
                    <h5 class="mb-0 fw-bold">@Model.Nome</h5>
                    <span class="badge bg-white text-primary mt-2 px-3 rounded-pill shadow-sm text-uppercase"
                        style="font-size: 0.7rem; letter-spacing: 1px;">
                        @Model.Ruolo
                    </span>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4 p-3 rounded-3 bg-light-subtle border border-light">
                        <div class="icon-square bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <small class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem;">Email</small>
                            <div class="fs-6 fw-medium text-dark">@Model.Email</div>
                        </div>
                    </div>
                    <div>
                        <small class="text-muted">Benvenuto nella tua area riservata. In questa sezione puoi gestire le
                            tue attività: visualizzare gli ultimi ordini, consultare le prenotazioni più frequenti e
                            cancellare gli acquisti effettuati da meno di un'ora.</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">

            <div class="card border border-dark border-opacity-10 shadow-sm mb-4 overflow-hidden card-hover-effect">
                <div
                    class="card-header bg-gradient-orders text-white py-3 d-flex justify-content-between align-items-center border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-receipt fa-lg me-3 opacity-75"></i>
                        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Ultimi Ordini</h6>
                    </div>
                    <span
                        class="badge bg-white text-primary rounded-pill shadow-sm px-3">@Model.UltimiOrdini?.Count()</span>
                </div>
                <div class="card-body p-0">
                    @if (Model.UltimiOrdini != null && Model.UltimiOrdini.Any())
                    {
                        <div class="table-scroll-container">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="ps-4 text-muted small text-uppercase fw-bold" style="width: 25%;">Data
                                        </th>
                                        <th class="text-muted small text-uppercase fw-bold">Descrizione</th>
                                        <th class="pe-4 text-end text-muted small text-uppercase fw-bold"
                                            style="width: 20%;">Prezzo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ordine in Model.UltimiOrdini)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <div class="d-flex align-items-center">
                                                    <div class="date-badge me-2">
                                                        <span class="day fw-bold">@ordine.Data.Day</span>
                                                        <span class="month text-uppercase">@ordine.Data.ToString("MMM")</span>
                                                    </div>
                                                    <small class="text-muted">@ordine.Data.ToString("yyyy")</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-medium text-dark">@ordine.Descrizione</span>
                                            </td>
                                            <td class="pe-4 text-end">
                                                <span class="fw-bold text-primary">
                                                    € @ordine.Prezzo.ToString("F2")
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-basket fa-3x text-muted opacity-25 mb-3"></i>
                            <h6 class="text-muted">Nessun ordine recente</h6>
                        </div>
                    }
                </div>
            </div>

            <div class="card border border-dark border-opacity-10 shadow-sm mb-4 overflow-hidden card-hover-effect" id="ordini">
                <div class="card-header bg-gradient-danger text-white py-3 border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock-rotate-left fa-lg me-3 opacity-75"></i>
                        <div>
                            <h6 class="mb-0 fw-bold text-uppercase tracking-wide">Gestione Cancellazioni</h6>
                            <small class="opacity-75" style="font-size: 0.75rem;">Disponibile entro 1 ora
                                dall'ordine</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (Model.UltimiOrdini != null && Model.UltimiOrdini.Any())
                    {
                        <div class="table-scroll-container">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="ps-4 text-muted small text-uppercase fw-bold" style="width: 25%;">Orario
                                        </th>
                                        <th class="text-muted small text-uppercase fw-bold">Dettaglio</th>
                                        <th class="pe-4 text-end text-muted small text-uppercase fw-bold"
                                            style="width: 20%;">Azione</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ordine in Model.UltimiOrdini)
                                    {
                                        <tr>
                                            <td class="ps-4 text-muted small">
                                                <i class="far fa-clock text-danger me-1"></i> @ordine.Data.ToString("HH:mm")
                                                <span class="text-muted ms-1">(@ordine.Data.ToString("dd/MM"))</span>
                                            </td>
                                            <td>
                                                <span class="fw-medium text-dark">@ordine.Descrizione</span>
                                            </td>
                                            <td class="pe-4 text-end">
                                                @if (ordine.Cancellabile)
                                                {
                                                    <form action="@Url.Action("CancellaOrdine", "AreaRiservata", new { id = ordine.Id })" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-danger btn-sm px-3 fw-bold rounded-pill shadow-sm custom-btn-cancel">
                                                            <i class="fas fa-times me-1"></i> Cancella
                                                        </button>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <span
                                                        class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25">Scaduto</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <h6 class="text-muted">Nessun ordine cancellabile</h6>
                        </div>
                    }
                </div>
            </div>

            <div class="card border border-dark border-opacity-10 shadow-sm overflow-hidden card-hover-effect">
                <div class="card border border-dark border-opacity-10 shadow-sm overflow-hidden card-hover-effect">
                    <div class="card-header bg-gradient-success text-white py-3 border-0">
                        <h6 class="mb-0 fw-bold text-uppercase tracking-wide">I tuoi preferiti (Top 2)</h6>
                    </div>
                    <div class="card-body bg-white">
                        @if (Model.AcquistiFrequenti != null && Model.AcquistiFrequenti.Any())
                        {
                            <div class="row g-3">
                                @foreach (var acquisto in Model.AcquistiFrequenti.Take(2))
                                {
                                    <div class="col-md-6">
                                        <div class="p-4 rounded-4 border-0 h-100 d-flex justify-content-between align-items-center"
                                            style="background: linear-gradient(145deg, #f0fff4 0%, #ffffff 100%); border: 1px solid #d1e7dd !important;">

                                            <div>
                                                <h5 class="mb-0 fw-bold text-dark">@acquisto.Descrizione</h5>
                                            </div>

                                            <div class="text-center ms-3 border-start border-success border-opacity-25 ps-4">
                                                <span
                                                    class="display-5 fw-bold text-success d-block lh-1">@acquisto.Quantita</span>
                                                <span class="small text-muted text-uppercase fw-bold"
                                                    style="font-size: 0.65rem; letter-spacing: 1px;">Volte</span>
                                            </div>

                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <h6 class="text-muted">Non ci sono ancora dati sufficienti</h6>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    /* 1. GRADIENTI PERSONALIZZATI */
    .bg-gradient-profile {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.5) 100%),
            url('/images/img_areariservata.jpg') center/cover no-repeat;
    }

    .bg-gradient-orders {
        background-color: rgba(0, 97, 242, 0.9);
    }

    .bg-gradient-danger {
        background-color: rgba(255, 65, 108, 0.9);
    }

    .bg-gradient-success {
        background-color: rgba(17, 153, 142, 0.9);
    }

    /* 2. EFFETTI HOVER E OMBRE */
    .card-hover-effect {
        transition: box-shadow 0.3s ease;
    }

    /* 3. ELEMENTI GRAFICI */
    .avatar-placeholder {
        width: 90px;
        height: 90px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid rgba(255, 255, 255, 0.3);
    }

    .icon-square {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .date-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 4px 8px;
        min-width: 50px;
    }

    .date-badge .day {
        font-size: 1.1rem;
        line-height: 1;
        color: #333;
    }

    .date-badge .month {
        font-size: 0.6rem;
        line-height: 1;
        color: #6c757d;
        margin-top: 2px;
    }

    /* 4. SCROLLBAR E TABLE FIX */
    .table-scroll-container {
        max-height: 320px;
        overflow-y: auto;
    }

    .table-scroll-container thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 5;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .tracking-wide {
        letter-spacing: 0.08em;
    }

    /* Scrollbar stilizzata */
    .table-scroll-container::-webkit-scrollbar {
        width: 5px;
    }

    .table-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .table-scroll-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 10px;
    }

    .table-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    .custom-btn-cancel {
        transition: all 0.2s;
    }

    .custom-btn-cancel:hover {
        transform: scale(1.05);
        background-color: #dc3545;
    }
</style>