@{
    ViewData["Title"] = "Planimetria Ufficio";
}

@section styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="~/css/seatmap.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/sidebar.css" asp-append-version="true" />
}

<div id="app-prenotazione" class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="bg-white p-2 rounded border shadow-sm">
            <input type="date" class="form-control border-0 fw-bold p-0" style="width: 130px" v-model="dataSelezionata"
                v-on:change="caricaDatiMappa">
        </div>
    </div>

    <div class="seatmap-wrapper">
        <div class="map-area">

            <div v-if="tooltip.visibile" class="custom-tooltip"
                :style="{ top: tooltip.y + 'px', left: tooltip.x + 'px' }">

                <div class="fw-bold text-warning mb-2"
                    style="font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px;">
                    {{ tooltip.dati.nome }}
                </div>

                <div class="tooltip-row mb-2">
                    <span class="badge bg-light text-dark border" style="font-size:0.7em">{{ tooltip.dati.tipo }}</span>

                    <span v-if="tooltip.dati.tipo === 'Ristorante'">
                        <i class="fa-solid fa-utensils text-info"></i> {{ tooltip.dati.postiOccupati }}/{{
                        tooltip.dati.postiTotali }}
                    </span>
                    <span v-else>
                        <span v-if="tooltip.dati.isOccupata" class="text-danger fw-bold">
                            <i class="fa-solid fa-xmark"></i> Occupato
                        </span>
                        <span v-else class="text-success fw-bold">
                            <i class="fa-solid fa-check"></i> Libero
                        </span>
                    </span>
                </div>

                <div v-if="tooltip.dati.metriQuadri || tooltip.dati.descrizione || tooltip.dati.haProiettore"
                    class="mt-2 pt-2 text-light opacity-75 small" style="border-top: 1px dashed rgba(255,255,255,0.2);">

                    <div v-if="tooltip.dati.metriQuadri" class="d-flex align-items-center gap-2 mb-1">
                        <i class="fa-solid fa-ruler-combined"></i>
                        <span>{{ tooltip.dati.metriQuadri }} m²</span>
                    </div>

                    <div v-if="tooltip.dati.haProiettore || tooltip.dati.haFinestre"
                        class="d-flex gap-3 mt-1 align-items-center">

                        <span v-if="tooltip.dati.haledwall" title="Ledwall">
                            <i class="fa-solid fa-video me-1"></i> LED WALL
                        </span>

                        <span v-if="tooltip.dati.haProiettore" title="Lavagna">
                            <i class="fa-solid fa-video me-1"></i> LAVAGNA INTERATTIVA
                        </span>
                        <span v-if="tooltip.dati.haFinestre" title="Luce Naturale">
                            <i class="fa-regular fa-sun me-1"></i> Finestra
                        </span>
                    </div>

                    <div v-if="tooltip.dati.descrizione" class="mt-2 fst-italic text-white-50"
                        style="white-space: normal; max-width: 200px; line-height: 1.2;">
                        {{ tooltip.dati.descrizione }}
                    </div>
                </div>
            </div>
            <div v-if="loading" class="spinner-border text-primary m-5"></div>

            <svg v-else viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <path id="office-chair"
                        d="M4,18 C4,20 16,20 16,18 L16,14 C16,8 4,8 4,14 Z M2,14 C2,6 18,6 18,14 L18,16 C20,16 20,20 18,20 L2,20 C0,20 0,16 2,16 Z"
                        class="chair-shape" />
                </defs>

                <image href="/images/piantina-base.png" x="0" y="0" width="1000" height="600" preserveAspectRatio="none"
                    style="opacity: 0.6; filter: grayscale(30%);" />

                <text x="850" y="520" class="map-label" transform="rotate(90, 960, 300)" style="font-size:18px">DESK
                    ROOM</text>
                <text x="850" y="800" class="map-label" transform="rotate(90, 960, 300)" style="font-size:18px">SALA
                    EVENTI</text>
                <text x="700" y="380" class="map-label">MEETING</text>
                <text x="310" y="380" class="map-label">DEV TEAM</text>
                <text x="513" y="380" class="map-label">DEV TEAM</text>
                <text x="103" y="380" class="map-label">MEETING</text>
                <text x="960" y="300" class="map-label" transform="rotate(90, 960, 300)"
                    style="font-size:18px">RISTORANTE</text>

                <g v-for="p in postazioni" :key="p.id" class="seat-group"
                    :class="getStatoClasse(p) + ' type-' + p.tipo.toLowerCase()" v-on:click="selezionaPostazione(p)"
                    @@mouseenter="mostraTooltip(p, $event)" @@mousemove="muoviTooltip($event)"
                    @@mouseleave="nascondiTooltip">

                    <g v-if="p.tipo === 'Singola'">
                        <use href="#office-chair" :x="p.x+5" :y="p.y+20" />
                        <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="3" class="desk-shape" />
                    </g>
                    <g v-else-if="p.tipo === 'Team'">
                        <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="6" class="desk-shape" />
                        <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="12" fill="#adb5bd"
                            text-anchor="middle" font-weight="bold" style="pointer-events:none">TEAM</text>
                        <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                        <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                        <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                    </g>
                    <g v-else-if="p.tipo === 'Riunioni'">
                        <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="20" class="desk-shape" />
                        <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="11" fill="#adb5bd"
                            text-anchor="middle" font-weight="bold" style="pointer-events:none">MEET</text>
                        <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                            :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                        <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                        <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                        <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                    </g>
                    <g v-else-if="p.tipo === 'Eventi'">
                        <rect :x="p.x" :y="p.y + 10" width="350" height="30" fill="#343a40" rx="2" />
                        <text :x="p.x + 175" :y="p.y + 30" font-size="12" fill="white" text-anchor="middle"
                            font-weight="bold" style="pointer-events:none; letter-spacing: 1px;">LED WALL</text>
                        <rect :x="p.x" :y="p.y+60" :width="p.width" :height="p.height-60" fill="white"
                            class="platea-shape" rx="4" />
                        <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 30" font-size="14" fill="#adb5bd"
                            text-anchor="middle" font-weight="bold">PLATEA</text>
                    </g>
                    <g v-else-if="p.tipo === 'Ristorante'">
                        <use href="#office-chair" :x="p.x + 30" :y="p.y - 20"
                            :transform="`rotate(180, ${p.x + 30}, ${p.y - 10})`" />
                        <use href="#office-chair" :x="p.x + 70" :y="p.y - 20"
                            :transform="`rotate(180, ${p.x + 80}, ${p.y - 10})`" />
                        <use href="#office-chair" :x="p.x + 10" :y="p.y + p.height" />
                        <use href="#office-chair" :x="p.x + 70" :y="p.y + p.height" />
                        <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="4" class="desk-shape" />
                        <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" text-anchor="middle" font-size="12"
                            fill="#adb5bd" font-weight="bold" style="pointer-events:none">
                            {{ p.postiTotali - p.postiOccupati }}/{{ p.postiTotali }}
                        </text>
                    </g>
                </g>
            </svg>
        </div>

        <partial name="Sidebar" />
    </div>

    <partial name="_StatsCards" />

    <partial name="_InfoCards" />

</div>

@section scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    loading: false, loadingBtn: false,
                    dataSelezionata: new Date().toISOString().split('T')[0],
                    postazioni: [], postazioneSelezionata: null,
                    numeroPostiRichiesti: 1,
                    tooltip: { visibile: false, dati: null, x: 0, y: 0 },

                    // --- NUOVI DATI PER LE CARD INFORMATIVE ---
                    storicoOrdini: [
                        { data: 'Ieri', descrizione: 'Desk 5 - Singola', tipo: 'Singola', prezzo: 25 },
                        { data: '05 Dic', descrizione: 'Pranzo x2 Persone', tipo: 'Ristorante', prezzo: 30 },
                        { data: '01 Dic', descrizione: 'Sala Blue - Riunioni', tipo: 'Riunioni', prezzo: 80 }
                    ],
                    novita: [
                        { data: 'Oggi', titolo: 'Nuova Area Relax', contenuto: 'Inaugurata la zona relax al 2° piano con macchinette caffè gratuite.' },
                        { data: 'Ieri', titolo: 'Manutenzione Wi-Fi', contenuto: 'Domani dalle 18:00 alle 19:00 manutenzione programmata della rete.' }
                    ],
                    menuSettimanale: {
                        'Lun': 'Lasagne alla Bolognese',
                        'Mar': 'Risotto ai Funghi Porcini',
                        'Mer': 'Pollo al Curry con Riso Basmati',
                        'Gio': 'Gnocchi al Pesto Genovese',
                        'Ven': 'Filetto di Orata con Patate'
                    }
                }
            },

            // --- FIX: LOGICA CALCOLO IBRIDA (Sedie vs Unità) ---
            computed: {
                stats() {
                    if (!this.postazioni || this.postazioni.length === 0) {
                        return { totali: 0, occupati: 0, liberi: 0, percentuale: 0 };
                    }

                    let totali = 0;
                    let occupati = 0;

                    this.postazioni.forEach(p => {
                        if (p.tipo === 'Ristorante') {
                            // RISTORANTE: Contiamo i singoli posti (es. 4 sedie)
                            totali += p.postiTotali;
                            occupati += p.postiOccupati;
                        } else {
                            // UFFICI/SALE: Contiamo l'UNITÀ immobiliare (1 prenotazione = 1 spazio occupato)
                            totali += 1;
                            occupati += (p.isOccupata ? 1 : 0);
                        }
                    });

                    let liberi = totali - occupati;
                    let perc = totali > 0 ? Math.round((occupati / totali) * 100) : 0;

                    return { totali, occupati, liberi, percentuale: perc };
                }
            },

            mounted() { this.caricaDatiMappa(); },
            methods: {
                caricaDatiMappa() {
                    this.loading = true; this.postazioneSelezionata = null;
                    fetch(`/Prenotazione/GetDatiMappa?data=${this.dataSelezionata}`)
                        .then(r => r.json()).then(d => { this.postazioni = d; this.loading = false; })
                        .catch(e => { console.error(e); this.loading = false; });
                },
                getStatoClasse(p) {
                    if (this.postazioneSelezionata && this.postazioneSelezionata.id === p.id) return "status-selected";
                    if (p.tipo === 'Ristorante') {
                        if (p.postiOccupati >= p.postiTotali) return "status-booked";
                        if (p.postiOccupati > 0) return "status-partial";
                        return "status-free";
                    }
                    return p.isOccupata ? "status-booked" : "status-free";
                },
                selezionaPostazione(p) {
                    if (p.tipo === 'Ristorante' && p.postiOccupati >= p.postiTotali) return;
                    if (p.tipo !== 'Ristorante' && p.isOccupata) return;

                    this.postazioneSelezionata = p;
                    this.numeroPostiRichiesti = 1;
                },
                confermaPrenotazione() {
                    this.loadingBtn = true;
                    let url = '/Prenotazione/Prenota';
                    let payload = { postazioneId: this.postazioneSelezionata.id, data: this.dataSelezionata };

                    if (this.postazioneSelezionata.tipo === 'Ristorante') {
                        url = '/Ristorazione/PrenotaTavolo';
                        payload.numeroPosti = this.numeroPostiRichiesti;
                    }

                    fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(async r => {
                        this.loadingBtn = false;
                        const res = await r.json();
                        if (r.ok) {
                            alert("✅ " + res.message);

                            // Aggiorno Storico
                            this.storicoOrdini.unshift({
                                data: 'Adesso',
                                descrizione: this.postazioneSelezionata.nome,
                                tipo: this.postazioneSelezionata.tipo,
                                prezzo: this.getPrezzoTotale()
                            });

                            this.caricaDatiMappa();
                        } else {
                            alert("❌ " + res.message);
                        }
                    });
                },

                // --- METODI TOOLTIP ---
                mostraTooltip(postazione, event) {
                    this.tooltip.dati = postazione;
                    this.tooltip.visibile = true;
                    this.muoviTooltip(event);
                },
                muoviTooltip(event) {
                    this.tooltip.x = event.clientX;
                    this.tooltip.y = event.clientY;
                },
                nascondiTooltip() {
                    this.tooltip.visibile = false;
                },

                // --- METODI PREZZI ---
                getPrezzoUnitario(tipo) {
                    switch (tipo) {
                        case 'Singola': return 25;
                        case 'Team': return 150;
                        case 'Riunioni': return 80;
                        case 'Eventi': return 500;
                        case 'Ristorante': return 15;
                        default: return 0;
                    }
                },
                getPrezzoTotale() {
                    if (!this.postazioneSelezionata) return 0;

                    let prezzoBase = this.getPrezzoUnitario(this.postazioneSelezionata.tipo);

                    if (this.postazioneSelezionata.tipo === 'Ristorante') {
                        return prezzoBase * this.numeroPostiRichiesti;
                    } else {
                        return prezzoBase;
                    }
                }
            }
        }).mount('#app-prenotazione');
    </script>
}