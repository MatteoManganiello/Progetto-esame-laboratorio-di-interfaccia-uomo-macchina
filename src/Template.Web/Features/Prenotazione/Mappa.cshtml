@{
    ViewData["Title"] = "Planimetria Ufficio";
    Layout = "_LayoutPrenotazione.cshtml";
}

@section scripts {
    <script>
        window.dashboardData = @Json.Serialize(ViewBag.DashboardData);
    </script>
    <script src="~/js/prenotazione.js" asp-append-version="true"></script>
}

<div class="map-card">
    <div class="map-area" style="position: relative; height: 100%;">

        <div v-if="tooltip.visibile" class="custom-tooltip"
            :style="{ top: tooltip.y + 'px', left: tooltip.x + 'px' }">

            <div class="fw-bold text-warning mb-2"
                style="font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px;">
                {{ tooltip.dati.nome }}
            </div>

            <div class="tooltip-row mb-2">
                <span class="badge bg-light text-dark border" style="font-size:0.7em">{{ tooltip.dati.tipo
                    }}</span>

                <span v-if="tooltip.dati.tipo === 'Ristorante'">
                    <i class="fa-solid fa-utensils text-info"></i> {{ tooltip.dati.postiOccupati }}/{{
                    tooltip.dati.postiTotali }}
                </span>
                <span v-else>
                    <span v-if="tooltip.dati.isOccupata" class="text-danger fw-bold">
                        <i class="fa-solid fa-xmark"></i> Occupato
                    </span>
                    <span v-else class="text-success fw-bold">
                        <i class="fa-solid fa-check"></i> Libero
                    </span>
                </span>
            </div>

            <div v-if="tooltip.dati.metriQuadri || tooltip.dati.descrizione || tooltip.dati.haProiettore"
                class="mt-2 pt-2 text-light opacity-75 small"
                style="border-top: 1px dashed rgba(255,255,255,0.2);">

                <div v-if="tooltip.dati.metriQuadri" class="d-flex align-items-center gap-2 mb-1">
                    <i class="fa-solid fa-ruler-combined"></i>
                    <span>{{ tooltip.dati.metriQuadri }} mÂ²</span>
                </div>

                <div v-if="tooltip.dati.haProiettore || tooltip.dati.haFinestre || tooltip.dati.haledwall || tooltip.dati.haArmadietto"
                    class="d-flex flex-column gap-1 mt-1 align-items-start">

                    <span v-if="tooltip.dati.haledwall" title="Ledwall">
                        <i class="fa-solid fa-video me-1"></i> LED WALL
                    </span>

                    <span v-if="tooltip.dati.haProiettore" title="Lavagna">
                        <i class="fa-solid fa-video me-1"></i> LAVAGNA INTERATTIVA
                    </span>

                    <span v-if="tooltip.dati.haFinestre" title="Luce Naturale">
                        <i class="fa-regular fa-sun me-2"></i> Finestra
                    </span>

                    <span v-if="tooltip.dati.haArmadietto" title="locker">
                        <i class="fa-solid fa-lock me-2"></i> Armadietto (Locker)
                    </span>
                </div>
                <div v-if="tooltip.dati.descrizione" class="mt-2 fst-italic text-white-50"
                    style="white-space: normal; max-width: 200px; line-height: 1.2;">
                    {{ tooltip.dati.descrizione }}
                </div>
            </div>
        </div>

        <div v-if="loading" class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary"></div>
        </div>

        <svg v-else viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
            <defs>
                <path id="office-chair"
                    d="M4,18 C4,20 16,20 16,18 L16,14 C16,8 4,8 4,14 Z M2,14 C2,6 18,6 18,14 L18,16 C20,16 20,20 18,20 L2,20 C0,20 0,16 2,16 Z"
                    class="chair-shape" />
            </defs>

            <image href="/images/piantina-base.png" x="0" y="0" width="1000" height="600"
                preserveAspectRatio="none" style="opacity: 0.6; filter: grayscale(30%);" />

            <text x="850" y="520" class="map-label" transform="rotate(90, 960, 300)"
                style="font-size:18px">DESK
                ROOM</text>
            <text x="850" y="800" class="map-label" transform="rotate(90, 960, 300)"
                style="font-size:18px">SALA
                EVENTI</text>
            <text x="700" y="380" class="map-label">MEETING</text>
            <text x="310" y="380" class="map-label">DEV TEAM</text>
            <text x="513" y="380" class="map-label">DEV TEAM</text>
            <text x="103" y="380" class="map-label">MEETING</text>
            <text x="960" y="300" class="map-label" transform="rotate(90, 960, 300)"
                style="font-size:18px">RISTORANTE</text>

            <g v-for="p in postazioni" :key="p.id" class="seat-group"
                :class="getStatoClasse(p) + ' type-' + p.tipo.toLowerCase()"
                v-on:click="selezionaPostazione(p)" @@mouseenter="mostraTooltip(p, $event)"
                @@mousemove="muoviTooltip($event)" @@mouseleave="nascondiTooltip">

                <g v-if="p.tipo === 'Singola'">
                    <use href="#office-chair" :x="p.x+5" :y="p.y+20" />
                    <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="3" class="desk-shape" />
                </g>
                <g v-else-if="p.tipo === 'Team'">
                    <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="6" class="desk-shape" />
                    <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="12" fill="#adb5bd"
                        text-anchor="middle" font-weight="bold" style="pointer-events:none">TEAM</text>
                    <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                    <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                    <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                </g>
                <g v-else-if="p.tipo === 'Riunioni'">
                    <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="20"
                        class="desk-shape" />
                    <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="11" fill="#adb5bd"
                        text-anchor="middle" font-weight="bold" style="pointer-events:none">MEET</text>
                    <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                        :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                    <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                    <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                    <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                </g>
                <g v-else-if="p.tipo === 'Eventi'">
                    <rect :x="p.x" :y="p.y + 10" width="350" height="30" fill="#343a40" rx="2" />
                    <text :x="p.x + 175" :y="p.y + 30" font-size="12" fill="white" text-anchor="middle"
                        font-weight="bold" style="pointer-events:none; letter-spacing: 1px;">LED WALL</text>
                    <rect :x="p.x" :y="p.y+60" :width="p.width" :height="p.height-60" fill="white"
                        class="platea-shape" rx="4" />
                    <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 30" font-size="14" fill="#adb5bd"
                        text-anchor="middle" font-weight="bold">PLATEA</text>
                </g>
                <g v-else-if="p.tipo === 'Ristorante'">
                    <use href="#office-chair" :x="p.x + 30" :y="p.y - 20"
                        :transform="`rotate(180, ${p.x + 30}, ${p.y - 10})`" />
                    <use href="#office-chair" :x="p.x + 70" :y="p.y - 20"
                        :transform="`rotate(180, ${p.x + 80}, ${p.y - 10})`" />
                    <use href="#office-chair" :x="p.x + 10" :y="p.y + p.height" />
                    <use href="#office-chair" :x="p.x + 70" :y="p.y + p.height" />
                    <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="4" class="desk-shape" />
                    <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" text-anchor="middle" font-size="12"
                        fill="#adb5bd" font-weight="bold" style="pointer-events:none">
                        {{ p.postiTotali - p.postiOccupati }}/{{ p.postiTotali }}
                    </text>
                </g>
            </g>
        </svg>
    </div>
</div>
