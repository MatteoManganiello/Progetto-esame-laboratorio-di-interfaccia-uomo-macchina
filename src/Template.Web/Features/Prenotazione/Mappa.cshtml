@{
    ViewData["Title"] = "Planimetria Ufficio";
}

@section styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="~/css/seatmap.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/sidebar.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/faqcard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/infocards.css" asp-append-version="true" />

}

<div id="app-prenotazione" class="container-fluid py-4">

    <div class="mb-4">
        <partial name="_StatsCards" />
    </div>


    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="d-flex gap-2">
            <a href="#faq-section"
                class="btn btn-info text-white border shadow-sm p-2 rounded d-flex align-items-center gap-2"
                style="min-width: 110px; justify-content: center;">
                <i class="fa-solid fa-book-open"></i>
                <span class="d-none d-md-inline fw-bold">Guida, leggi prima di iniziare con la prenotazione</span>
            </a>

            <a href="#faq-section" class="btn border shadow-sm p-2 rounded d-flex align-items-center gap-2 text-white"
                style="background-color: #6f42c1; border-color: #6f42c1; min-width: 110px; justify-content: center;">
                <i class="fa-solid fa-circle-question"></i>
                <span class="d-none d-md-inline fw-bold">FAQ</span>
            </a>
        </div>

        <div class="bg-white p-2 rounded border shadow-sm">
            <input type="date" class="form-control border-0 fw-bold p-0" style="width: 130px" v-model="dataSelezionata"
                v-on:change="caricaDatiMappa">
        </div>

    </div>


    <div class="row g-4">

        <div class="col-lg-9">
            <div class="map-card">
                <div class="map-area" style="position: relative; height: 100%;">

                    <div v-if="tooltip.visibile" class="custom-tooltip"
                        :style="{ top: tooltip.y + 'px', left: tooltip.x + 'px' }">

                        <div class="fw-bold text-warning mb-2"
                            style="font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px;">
                            {{ tooltip.dati.nome }}
                        </div>

                        <div class="tooltip-row mb-2">
                            <span class="badge bg-light text-dark border" style="font-size:0.7em">{{ tooltip.dati.tipo
                                }}</span>

                            <span v-if="tooltip.dati.tipo === 'Ristorante'">
                                <i class="fa-solid fa-utensils text-info"></i> {{ tooltip.dati.postiOccupati }}/{{
                                tooltip.dati.postiTotali }}
                            </span>
                            <span v-else>
                                <span v-if="tooltip.dati.isOccupata" class="text-danger fw-bold">
                                    <i class="fa-solid fa-xmark"></i> Occupato
                                </span>
                                <span v-else class="text-success fw-bold">
                                    <i class="fa-solid fa-check"></i> Libero
                                </span>
                            </span>
                        </div>

                        <div v-if="tooltip.dati.metriQuadri || tooltip.dati.descrizione || tooltip.dati.haProiettore"
                            class="mt-2 pt-2 text-light opacity-75 small"
                            style="border-top: 1px dashed rgba(255,255,255,0.2);">

                            <div v-if="tooltip.dati.metriQuadri" class="d-flex align-items-center gap-2 mb-1">
                                <i class="fa-solid fa-ruler-combined"></i>
                                <span>{{ tooltip.dati.metriQuadri }} m²</span>
                            </div>

                            <div v-if="tooltip.dati.haProiettore || tooltip.dati.haFinestre"
                                class="d-flex gap-3 mt-1 align-items-center">

                                <span v-if="tooltip.dati.haledwall" title="Ledwall">
                                    <i class="fa-solid fa-video me-1"></i> LED WALL
                                </span>

                                <span v-if="tooltip.dati.haProiettore" title="Lavagna">
                                    <i class="fa-solid fa-video me-1"></i> LAVAGNA INTERATTIVA
                                </span>
                                <span v-if="tooltip.dati.haFinestre" title="Luce Naturale">
                                    <i class="fa-regular fa-sun me-1"></i> Finestra
                                </span>
                            </div>

                            <div v-if="tooltip.dati.descrizione" class="mt-2 fst-italic text-white-50"
                                style="white-space: normal; max-width: 200px; line-height: 1.2;">
                                {{ tooltip.dati.descrizione }}
                            </div>
                        </div>
                    </div>

                    <div v-if="loading" class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-primary"></div>
                    </div>

                    <svg v-else viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <path id="office-chair"
                                d="M4,18 C4,20 16,20 16,18 L16,14 C16,8 4,8 4,14 Z M2,14 C2,6 18,6 18,14 L18,16 C20,16 20,20 18,20 L2,20 C0,20 0,16 2,16 Z"
                                class="chair-shape" />
                        </defs>

                        <image href="/images/piantina-base.png" x="0" y="0" width="1000" height="600"
                            preserveAspectRatio="none" style="opacity: 0.6; filter: grayscale(30%);" />

                        <text x="850" y="520" class="map-label" transform="rotate(90, 960, 300)"
                            style="font-size:18px">DESK
                            ROOM</text>
                        <text x="850" y="800" class="map-label" transform="rotate(90, 960, 300)"
                            style="font-size:18px">SALA
                            EVENTI</text>
                        <text x="700" y="380" class="map-label">MEETING</text>
                        <text x="310" y="380" class="map-label">DEV TEAM</text>
                        <text x="513" y="380" class="map-label">DEV TEAM</text>
                        <text x="103" y="380" class="map-label">MEETING</text>
                        <text x="960" y="300" class="map-label" transform="rotate(90, 960, 300)"
                            style="font-size:18px">RISTORANTE</text>

                        <g v-for="p in postazioni" :key="p.id" class="seat-group"
                            :class="getStatoClasse(p) + ' type-' + p.tipo.toLowerCase()"
                            v-on:click="selezionaPostazione(p)" @@mouseenter="mostraTooltip(p, $event)"
                            @@mousemove="muoviTooltip($event)" @@mouseleave="nascondiTooltip">

                            <g v-if="p.tipo === 'Singola'">
                                <use href="#office-chair" :x="p.x+5" :y="p.y+20" />
                                <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="3" class="desk-shape" />
                            </g>
                            <g v-else-if="p.tipo === 'Team'">
                                <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="6" class="desk-shape" />
                                <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="12" fill="#adb5bd"
                                    text-anchor="middle" font-weight="bold" style="pointer-events:none">TEAM</text>
                                <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                                <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                                <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                            </g>
                            <g v-else-if="p.tipo === 'Riunioni'">
                                <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="20"
                                    class="desk-shape" />
                                <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" font-size="11" fill="#adb5bd"
                                    text-anchor="middle" font-weight="bold" style="pointer-events:none">MEET</text>
                                <use href="#office-chair" :x="p.x+20" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+30}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+p.width/2}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+p.width-40" :y="p.y-20"
                                    :transform="`rotate(180, ${p.x+p.width-30}, ${p.y-10})`" />
                                <use href="#office-chair" :x="p.x+20" :y="p.y+p.height" />
                                <use href="#office-chair" :x="p.x+p.width/2-10" :y="p.y+p.height" />
                                <use href="#office-chair" :x="p.x+p.width-40" :y="p.y+p.height" />
                            </g>
                            <g v-else-if="p.tipo === 'Eventi'">
                                <rect :x="p.x" :y="p.y + 10" width="350" height="30" fill="#343a40" rx="2" />
                                <text :x="p.x + 175" :y="p.y + 30" font-size="12" fill="white" text-anchor="middle"
                                    font-weight="bold" style="pointer-events:none; letter-spacing: 1px;">LED WALL</text>
                                <rect :x="p.x" :y="p.y+60" :width="p.width" :height="p.height-60" fill="white"
                                    class="platea-shape" rx="4" />
                                <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 30" font-size="14" fill="#adb5bd"
                                    text-anchor="middle" font-weight="bold">PLATEA</text>
                            </g>
                            <g v-else-if="p.tipo === 'Ristorante'">
                                <use href="#office-chair" :x="p.x + 30" :y="p.y - 20"
                                    :transform="`rotate(180, ${p.x + 30}, ${p.y - 10})`" />
                                <use href="#office-chair" :x="p.x + 70" :y="p.y - 20"
                                    :transform="`rotate(180, ${p.x + 80}, ${p.y - 10})`" />
                                <use href="#office-chair" :x="p.x + 10" :y="p.y + p.height" />
                                <use href="#office-chair" :x="p.x + 70" :y="p.y + p.height" />
                                <rect :x="p.x" :y="p.y" :width="p.width" :height="p.height" rx="4" class="desk-shape" />
                                <text :x="p.x + p.width/2" :y="p.y + p.height/2 + 5" text-anchor="middle" font-size="12"
                                    fill="#adb5bd" font-weight="bold" style="pointer-events:none">
                                    {{ p.postiTotali - p.postiOccupati }}/{{ p.postiTotali }}
                                </text>
                            </g>
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="sidebar-card">
                <partial name="Sidebar" />
            </div>
        </div>
    </div>

    <div class="mt-4">
        <partial name="_InfoCards" />
    </div>
    <div id="faq-section">
        <partial name="_FaqCard" />
    </div>

</div>

@section scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        window.dashboardData = @Json.Serialize(ViewBag.DashboardData);
    </script>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                // Recupero dati dal server (se presenti)
                const dbData = window.dashboardData || {};

                return {
                    loading: false,
                    loadingBtn: false,
                    dataSelezionata: new Date().toISOString().split('T')[0],
                    postazioni: [],
                    postazioneSelezionata: null,
                    numeroPostiRichiesti: 1,
                    tooltip: { visibile: false, dati: null, x: 0, y: 0 },

                    // --- NOVITÀ: CARRELLO ---
                    carrello: [],

                    // Nome Intestatario (Recuperato dal backend o vuoto)
                    nomePrenotazione: dbData.nomeUtente || '',

                    // --- DATI CARD INFORMATIVE (Con fallback) ---
                    storicoOrdini: dbData.storicoOrdini || [],
                    novita: dbData.novita || [
                        { data: 'Oggi', titolo: 'Nuova Area Relax', contenuto: 'Inaugurata la zona relax al 2° piano.' },
                        { data: 'Ieri', titolo: 'Manutenzione Wi-Fi', contenuto: 'Domani manutenzione programmata.' }
                    ],
                    menuSettimanale: dbData.menuSettimanale || {
                        'Lun': 'Lasagne alla Bolognese',
                        'Mar': 'Risotto ai Funghi',
                        'Mer': 'Pollo al Curry',
                        'Gio': 'Gnocchi al Pesto',
                        'Ven': 'Orata con Patate'
                    }
                }
            },

            computed: {
                stats() {
                    if (!this.postazioni || this.postazioni.length === 0) {
                        return { totali: 0, occupati: 0, liberi: 0, percentuale: 0 };
                    }

                    let totali = 0;
                    let occupati = 0;

                    this.postazioni.forEach(p => {
                        if (p.tipo === 'Ristorante') {
                            totali += p.postiTotali;
                            occupati += p.postiOccupati;
                        } else {
                            totali += 1;
                            occupati += (p.isOccupata ? 1 : 0);
                        }
                    });

                    let liberi = totali - occupati;
                    let perc = totali > 0 ? Math.round((occupati / totali) * 100) : 0;

                    return { totali, occupati, liberi, percentuale: perc };
                }
            },

            mounted() {
                this.caricaDatiMappa();
            },

            methods: {
                caricaDatiMappa() {
                    this.loading = true;
                    this.postazioneSelezionata = null;
                    fetch(`/Prenotazione/GetDatiMappa?data=${this.dataSelezionata}`)
                        .then(r => r.json())
                        .then(d => {
                            this.postazioni = d;
                            this.loading = false;
                        })
                        .catch(e => { console.error(e); this.loading = false; });
                },

                getStatoClasse(p) {
                    if (this.postazioneSelezionata && this.postazioneSelezionata.id === p.id) return "status-selected";

                    // Verifica se è nel carrello (opzionale, per dargli un colore diverso)
                    if (this.carrello.some(x => x.postazione.id === p.id)) return "status-selected";

                    if (p.tipo === 'Ristorante') {
                        if (p.postiOccupati >= p.postiTotali) return "status-booked";
                        if (p.postiOccupati > 0) return "status-partial";
                        return "status-free";
                    }
                    return p.isOccupata ? "status-booked" : "status-free";
                },

                selezionaPostazione(p) {
                    // Impedisci selezione se occupato
                    if (p.tipo === 'Ristorante' && p.postiOccupati >= p.postiTotali) return;
                    if (p.tipo !== 'Ristorante' && p.isOccupata) return;

                    this.postazioneSelezionata = p;
                    this.numeroPostiRichiesti = 1;

                    // Se l'utente non ha un nome, proviamo a ricaricarlo (UX)
                    if (!this.nomePrenotazione && window.dashboardData && window.dashboardData.nomeUtente) {
                        this.nomePrenotazione = window.dashboardData.nomeUtente;
                    }
                },

                // --- NUOVI METODI CARRELLO ---

                aggiungiAlCarrello() {
                    if (!this.postazioneSelezionata) return;

                    // Controlla se esiste già
                    let index = this.carrello.findIndex(x => x.postazione.id === this.postazioneSelezionata.id);

                    let item = {
                        postazione: this.postazioneSelezionata,
                        numeroPersone: parseInt(this.numeroPostiRichiesti)
                    };

                    if (index > -1) {
                        // Aggiorna esistente
                        this.carrello[index] = item;
                    } else {
                        // Aggiungi nuovo
                        this.carrello.push(item);
                    }

                    // Chiudi selezione
                    this.postazioneSelezionata = null;
                },

                rimuoviDalCarrello(id) {
                    this.carrello = this.carrello.filter(x => x.postazione.id !== id);
                },

                // --- NUOVA LOGICA DI CONFERMA (Invia Lista Elementi) ---
                confermaPrenotazione() {
                    // Se l'utente ha una selezione aperta ma non l'ha aggiunta al carrello, aggiungiamola ora
                    if (this.postazioneSelezionata) {
                        this.aggiungiAlCarrello();
                    }

                    if (this.carrello.length === 0) return;

                    this.loadingBtn = true;

                    // Prepariamo la lista 'Elementi' come vuole il C#
                    let elementiApi = this.carrello.map(item => ({
                        PostazioneId: item.postazione.id,
                        NumeroPersone: item.numeroPersone
                    }));

                    let payload = {
                        Data: this.dataSelezionata,
                        Elementi: elementiApi, // <--- LISTA NUOVA
                        // Intestatario: this.nomePrenotazione (Opzionale, il backend ora lo ignora o lo usa come log)
                    };

                    fetch('/Prenotazione/Prenota', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(async r => {
                        this.loadingBtn = false;
                        const res = await r.json();

                        if (r.ok) {
                            alert("✅ " + res.message);

                            // Aggiorno storico ordini (solo visivo)
                            this.carrello.forEach(item => {
                                this.storicoOrdini.unshift({
                                    data: 'Adesso',
                                    descrizione: item.postazione.nome + (item.postazione.tipo === 'Ristorante' ? ` (x${item.numeroPersone})` : ''),
                                    tipo: item.postazione.tipo,
                                    prezzo: this.getPrezzoItem(item)
                                });
                            });

                            // Reset
                            this.carrello = [];
                            this.postazioneSelezionata = null;
                            this.caricaDatiMappa(); // Ricarica per vedere i rossi
                        } else {
                            alert("❌ Errore: " + (res.message || "Qualcosa è andato storto"));
                        }
                    }).catch(err => {
                        this.loadingBtn = false;
                        console.error(err);
                        alert("❌ Errore di connessione al server.");
                    });
                },

                // --- CALCOLO PREZZI ---
                getPrezzoUnitario(tipo) {
                    switch (tipo) {
                        case 'Singola': return 25;
                        case 'Team': return 150;
                        case 'Riunioni': return 80;
                        case 'Eventi': return 500;
                        case 'Ristorante': return 15;
                        default: return 0;
                    }
                },

                // Prezzo di una riga del carrello
                getPrezzoItem(item) {
                    let base = this.getPrezzoUnitario(item.postazione.tipo);
                    return item.postazione.tipo === 'Ristorante' ? base * item.numeroPersone : base;
                },

                // Totale dell'intero carrello
                getTotaleCarrello() {
                    return this.carrello.reduce((acc, item) => acc + this.getPrezzoItem(item), 0);
                },

                // Prezzo della selezione corrente (prima di aggiungerla al carrello)
                getPrezzoTotale() {
                    if (!this.postazioneSelezionata) return 0;
                    let base = this.getPrezzoUnitario(this.postazioneSelezionata.tipo);
                    return this.postazioneSelezionata.tipo === 'Ristorante' ? base * this.numeroPostiRichiesti : base;
                },

                // --- TOOLTIP ---
                mostraTooltip(postazione, event) {
                    this.tooltip.dati = postazione;
                    this.tooltip.visibile = true;
                    this.muoviTooltip(event);
                },
                muoviTooltip(event) {
                    this.tooltip.x = event.clientX;
                    this.tooltip.y = event.clientY;
                },
                nascondiTooltip() {
                    this.tooltip.visibile = false;
                }
            }
        }).mount('#app-prenotazione');
    </script>
}